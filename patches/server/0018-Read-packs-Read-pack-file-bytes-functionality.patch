From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Sat, 6 May 2023 11:46:15 +0200
Subject: [PATCH] Read packs - Read pack file bytes functionality

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Fiddle - https://fiddlemc.org

diff --git a/src/main/java/org/fiddlemc/fiddle/pack/reader/ArchivePackBeingRead.java b/src/main/java/org/fiddlemc/fiddle/pack/reader/ArchivePackBeingRead.java
index 40a6f98234f280a0c51f23ff9db7a7a7816c4de3..84394a25d8425a94d36048a5613bac01cca99582 100644
--- a/src/main/java/org/fiddlemc/fiddle/pack/reader/ArchivePackBeingRead.java
+++ b/src/main/java/org/fiddlemc/fiddle/pack/reader/ArchivePackBeingRead.java
@@ -2,10 +2,14 @@
 
 package org.fiddlemc.fiddle.pack.reader;
 
+import it.unimi.dsi.fastutil.bytes.ByteArrayList;
+import it.unimi.dsi.fastutil.bytes.ByteList;
+import net.sf.sevenzipjbinding.ExtractOperationResult;
 import net.sf.sevenzipjbinding.SevenZip;
 import net.sf.sevenzipjbinding.SevenZipException;
 import net.sf.sevenzipjbinding.impl.RandomAccessFileInStream;
 import net.sf.sevenzipjbinding.simple.ISimpleInArchiveItem;
+import org.jetbrains.annotations.Nullable;
 
 import java.io.*;
 import java.util.Arrays;
@@ -55,6 +59,48 @@ final class ArchivePackBeingRead extends PackBeingRead {
             this.item = item;
         }
 
+        @Override
+        protected byte[] readBytes() throws PackParseException {
+            Long size;
+            try {
+                size = this.item.getSize();
+            } catch (SevenZipException e) {
+                throw new PackParseException("An exception occurred while getting the size of a file ('" + this.pathInArchive + "') in a pack archive ('" + ArchivePackBeingRead.this.packFile.getPath() + "'): " + e.getMessage(), e);
+            }
+            final byte @Nullable [] bytes;
+            final int[] bytesIndex = {0};
+            final @Nullable ByteList byteList;
+            if (size != null && size >= 0) {
+                if (size > Integer.MAX_VALUE - 8) {
+                    throw new PackParseException("A file ('" + this.pathInArchive + "') in a pack archive ('" + ArchivePackBeingRead.this.packFile.getPath() + "' is too large: " + size + " bytes");
+                }
+                bytes = new byte[size.intValue()];
+                byteList = null;
+            } else {
+                bytes = null;
+                byteList = new ByteArrayList(2048);
+            }
+            try {
+                var result = this.item.extractSlow(data -> {
+                    if (bytes != null) {
+                        System.arraycopy(data, 0, bytes, bytesIndex[0], data.length);
+                        bytesIndex[0] += data.length;
+                    } else {
+                        for (byte value : data) {
+                            byteList.add(value);
+                        }
+                    }
+                    return data.length;
+                });
+                if (result != ExtractOperationResult.OK) {
+                    throw new PackParseException("Reading bytes from a file ('" + this.pathInArchive + "') in a pack archive ('" + ArchivePackBeingRead.this.packFile.getPath() + "' failed: " + result);
+                }
+            } catch (SevenZipException e) {
+                throw new PackParseException("An exception occurred while reading bytes from a file ('" + this.pathInArchive + "') in a pack archive ('" + ArchivePackBeingRead.this.packFile.getPath() + "': " + e.getMessage(), e);
+            }
+            return bytes != null ? bytes : byteList.toArray(new byte[0]);
+        }
+
     }
 
 }
diff --git a/src/main/java/org/fiddlemc/fiddle/pack/reader/DirectoryPackBeingRead.java b/src/main/java/org/fiddlemc/fiddle/pack/reader/DirectoryPackBeingRead.java
index cecab54adf4ac300c17445a067f25297276006bf..7f87425e2a2537020527fc73c2171e56837779a5 100644
--- a/src/main/java/org/fiddlemc/fiddle/pack/reader/DirectoryPackBeingRead.java
+++ b/src/main/java/org/fiddlemc/fiddle/pack/reader/DirectoryPackBeingRead.java
@@ -48,6 +48,15 @@ final class DirectoryPackBeingRead extends PackBeingRead {
             this.file = file;
         }
 
+        @Override
+        protected byte[] readBytes() throws PackParseException {
+            try {
+                return Files.readAllBytes(this.file.toPath());
+            } catch (IOException e) {
+                throw new PackParseException("An exception of type " + e.getClass().getSimpleName() + " occurred while reading a file ('" + this.pathInArchive + "') in a pack folder ('" + DirectoryPackBeingRead.this.packFile.getPath() + "'): " + e.getMessage(), e);
+            }
+        }
+
     }
 
 }
diff --git a/src/main/java/org/fiddlemc/fiddle/pack/reader/PackBeingRead.java b/src/main/java/org/fiddlemc/fiddle/pack/reader/PackBeingRead.java
index cdeb97b68aa4816523b659ae762ced7321a82d08..369eda307814e98ee8a4e16ef73d6353499c78f5 100644
--- a/src/main/java/org/fiddlemc/fiddle/pack/reader/PackBeingRead.java
+++ b/src/main/java/org/fiddlemc/fiddle/pack/reader/PackBeingRead.java
@@ -2,11 +2,13 @@
 
 package org.fiddlemc.fiddle.pack.reader;
 
+import com.google.common.base.Charsets;
 import org.jetbrains.annotations.Nullable;
 
 import java.io.File;
 import java.io.IOException;
 import java.util.Arrays;
+import java.util.List;
 import java.util.Map;
 import java.util.function.Function;
 import java.util.stream.Collectors;
@@ -59,11 +61,59 @@ public sealed abstract class PackBeingRead permits ArchivePackBeingRead, Directo
         public final String pathInArchive;
         public final boolean isDirectory;
 
+        /**
+         * The byte content of this file, or null if not currently cached.
+         */
+        private byte @Nullable [] cachedBytes;
+
         protected FileInPack(String pathInArchive, boolean isDirectory) {
             this.pathInArchive = pathInArchive;
             this.isDirectory = isDirectory;
         }
 
+        /**
+         * @return The files in this directory. This includes all deeply nested files, not only the top-level ones.
+         * @throws IllegalStateException If this file is not a {@linkplain #isDirectory directory}.
+         */
+        public List<FileInPack> getSubfiles() {
+            if (!this.isDirectory) {
+                throw new IllegalStateException("Tried to get sub-files at a pack path that is not a directory: " + this.pathInArchive);
+            }
+            return Arrays.stream(PackBeingRead.this.getFiles())
+                .filter(file -> file.pathInArchive.startsWith(this.pathInArchive + "/") || file.pathInArchive.startsWith(this.pathInArchive + "\\"))
+                .toList();
+        }
+
+        protected abstract byte[] readBytes() throws PackParseException;
+
+        /**
+         * @param cache Whether to cache the result (must be cleared with {@link #clearCachedBytes()} later).
+         * @return The bytes in this file.
+         */
+        public byte[] getBytes(boolean cache) throws PackParseException {
+            if (this.cachedBytes != null) {
+                return this.cachedBytes;
+            }
+            var bytes = this.readBytes();
+            if (cache) {
+                this.cachedBytes = bytes;
+            }
+            return bytes;
+        }
+
+        /**
+         * @return The content of this file as a string.
+         *
+         * @see #getBytes(boolean)
+         */
+        public String getString(boolean cache) throws PackParseException {
+            return new String(this.getBytes(cache), Charsets.UTF_8);
+        }
+
+        public void clearCachedBytes() {
+            this.cachedBytes = null;
+        }
+
     }
 
 }
diff --git a/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java b/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java
index ad99a611fb76ba4e39cd4135f5f1fe72c7ee982d..5a7db856f24b11af28e866f33f0d4d29c09f8bb2 100644
--- a/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java
+++ b/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java
@@ -73,6 +73,13 @@ public final class PackReader {
             }
         });
 
+        // Clear any file contents stored in memory
+        packsBeingRead.forEach(pack -> {
+            for (var file : pack.getFiles()) {
+                file.clearCachedBytes();
+            }
+        });
+
         // Deallocate the opened packs
         packsBeingRead.clear();
 
