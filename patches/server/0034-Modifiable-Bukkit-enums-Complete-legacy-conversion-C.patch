From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Mon, 8 Jan 2024 19:04:41 +0100
Subject: [PATCH] Modifiable Bukkit enums - Complete legacy conversion -
 Conversion is explicitly for item or block

* Makes the `itemPriority` parameter of the `CraftLegacy.fromLegacy` method required.
* Modifies occurrences of abovementioned method to explicitly specify a value for the parameter.

This is, apart from the benefits of increased explicitness, so the full coverage of legacy conversion can be tested in the "Modifiable Bukkit enums - Complete legacy conversion - Test completeness" patch.

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Fiddle - https://fiddlemc.org

diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
index 471ae4458e7ea7c29d7551b32cec98180fbccd4e..01a1282b595ba368026affaee0dc0b34d48d0fc3 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
@@ -102,7 +102,7 @@ public class CraftInventory implements Inventory {
     @Override
     public boolean contains(Material material) {
         Preconditions.checkArgument(material != null, "Material cannot be null");
-        material = CraftLegacy.fromLegacy(material);
+        material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         for (ItemStack item : this.getStorageContents()) {
             if (item != null && item.getType() == material) {
                 return true;
@@ -127,7 +127,7 @@ public class CraftInventory implements Inventory {
     @Override
     public boolean contains(Material material, int amount) {
         Preconditions.checkArgument(material != null, "Material cannot be null");
-        material = CraftLegacy.fromLegacy(material);
+        material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         if (amount <= 0) {
             return true;
         }
@@ -176,7 +176,7 @@ public class CraftInventory implements Inventory {
     @Override
     public HashMap<Integer, ItemStack> all(Material material) {
         Preconditions.checkArgument(material != null, "Material cannot be null");
-        material = CraftLegacy.fromLegacy(material);
+        material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         HashMap<Integer, ItemStack> slots = new HashMap<>();
 
         ItemStack[] inventory = this.getStorageContents();
@@ -206,7 +206,7 @@ public class CraftInventory implements Inventory {
     @Override
     public int first(Material material) {
         Preconditions.checkArgument(material != null, "Material cannot be null");
-        material = CraftLegacy.fromLegacy(material);
+        material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         ItemStack[] inventory = this.getStorageContents();
         for (int i = 0; i < inventory.length; i++) {
             ItemStack item = inventory[i];
@@ -261,7 +261,7 @@ public class CraftInventory implements Inventory {
 
     public int firstPartial(Material material) {
         Preconditions.checkArgument(material != null, "Material cannot be null");
-        material = CraftLegacy.fromLegacy(material);
+        material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         ItemStack[] inventory = this.getStorageContents();
         for (int i = 0; i < inventory.length; i++) {
             ItemStack item = inventory[i];
@@ -420,7 +420,7 @@ public class CraftInventory implements Inventory {
     @Override
     public void remove(Material material) {
         Preconditions.checkArgument(material != null, "Material cannot be null");
-        material = CraftLegacy.fromLegacy(material);
+        material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         ItemStack[] items = this.getStorageContents();
         for (int i = 0; i < items.length; i++) {
             if (items[i] != null && items[i].getType() == material) {
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java
index 9469b0d5d8a46ac17c3998a4b537a4feb1deb3b0..52cba66906940539fd9f6bcb4a4b7fbb37c25501 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java
@@ -48,7 +48,7 @@ public final class CraftItemFactory implements ItemFactory {
 
     @Override
     public boolean isApplicable(ItemMeta meta, Material type) {
-        type = CraftLegacy.fromLegacy(type); // This may be called from legacy item stacks, try to get the right material
+        type = CraftLegacy.fromLegacy(type, true); // This may be called from legacy item stacks, try to get the right material // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         if (type == null || meta == null) {
             return false;
         }
@@ -65,7 +65,7 @@ public final class CraftItemFactory implements ItemFactory {
     }
 
     private ItemMeta getItemMeta(Material material, CraftMetaItem meta) {
-        material = CraftLegacy.fromLegacy(material); // This may be called from legacy item stacks, try to get the right material
+        material = CraftLegacy.fromLegacy(material, true); // This may be called from legacy item stacks, try to get the right material // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         switch (material) {
         case AIR:
             return null;
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
index 654694515b4b9257a41c8623675fa3abc51a1cb7..31fe15bae57ede8c87619d16166840d92207a4c3 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
@@ -685,7 +685,7 @@ public final class CraftItemStack extends ItemStack {
         if (this.handle == null || that.handle == null) {
             return false;
         }
-        Material comparisonType = CraftLegacy.fromLegacy(that.getType()); // This may be called from legacy item stacks, try to get the right material
+        Material comparisonType = CraftLegacy.fromLegacy(that.getType(), true); // This may be called from legacy item stacks, try to get the right material // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         if (!(comparisonType == this.getType() && this.getDurability() == that.getDurability())) {
             return false;
         }
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java
index 18b9dcdc2b4bfacd4705085c947a5204a7a3cca3..366356788ecbbf7fb6485997b158c7ff474287c2 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java
@@ -307,7 +307,7 @@ public class CraftMetaSpawnEgg extends CraftMetaItem implements SpawnEggMeta {
                 this.entityTag.remove(CraftMetaSpawnEgg.ENTITY_ID.NBT);
             }
 
-            return CraftLegacy.fromLegacy(new MaterialData(Material.LEGACY_MONSTER_EGG, (byte) this.spawnedType.getTypeId()));
+            return CraftLegacy.fromLegacy(new MaterialData(Material.LEGACY_MONSTER_EGG, (byte) this.spawnedType.getTypeId()), true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         }
 
         return super.updateMaterial(material);
diff --git a/src/main/java/org/bukkit/craftbukkit/legacy/CraftLegacy.java b/src/main/java/org/bukkit/craftbukkit/legacy/CraftLegacy.java
index 2677e21d8239bf0361a3bc5c9a50c328e54d70f6..d9f731d605add107c0235c8f8db009bb924fb8a2 100644
--- a/src/main/java/org/bukkit/craftbukkit/legacy/CraftLegacy.java
+++ b/src/main/java/org/bukkit/craftbukkit/legacy/CraftLegacy.java
@@ -165,16 +165,12 @@ public final class CraftLegacy {
         return (mappedData == null) ? new MaterialData(Material.LEGACY_AIR) : mappedData;
     }
 
-    public static Material fromLegacy(Material material) {
+    public static Material fromLegacy(Material material, boolean itemPriority) { // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         if (material == null || !material.isLegacy()) {
             return material;
         }
 
-        return CraftLegacy.fromLegacy(new MaterialData(material));
-    }
-
-    public static Material fromLegacy(MaterialData materialData) {
-        return CraftLegacy.fromLegacy(materialData, false);
+        return CraftLegacy.fromLegacy(new MaterialData(material), itemPriority); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
     }
 
     public static Material fromLegacy(MaterialData materialData, boolean itemPriority) {
diff --git a/src/main/java/org/bukkit/craftbukkit/util/CraftLegacy.java b/src/main/java/org/bukkit/craftbukkit/util/CraftLegacy.java
index c8dde75de231b5fdde88f5bc111c21883d9c3f49..c788b24c8030a69f1428b751d218e250d142a36c 100644
--- a/src/main/java/org/bukkit/craftbukkit/util/CraftLegacy.java
+++ b/src/main/java/org/bukkit/craftbukkit/util/CraftLegacy.java
@@ -14,16 +14,18 @@ public final class CraftLegacy {
         //
     }
 
-    public static Material fromLegacy(Material material) {
+    public static Material fromLegacy(Material material, boolean itemPriority) { // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         if (material == null || !material.isLegacy()) {
             return material;
         }
 
-        return org.bukkit.craftbukkit.legacy.CraftLegacy.fromLegacy(material);
+        return org.bukkit.craftbukkit.legacy.CraftLegacy.fromLegacy(material, itemPriority); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
     }
 
-    public static Material fromLegacy(MaterialData materialData) {
-        return org.bukkit.craftbukkit.legacy.CraftLegacy.fromLegacy(materialData);
+    // Fiddle start - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
+    public static Material fromLegacy(MaterialData materialData, boolean itemPriority) {
+        return org.bukkit.craftbukkit.legacy.CraftLegacy.fromLegacy(materialData, itemPriority);
+        // Fiddle end - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
     }
 
     public static Material[] modern_values() {
diff --git a/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java b/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java
index bee150e8c179ce6e33c44382a04bc06ae4be5257..a6a3b210fb399a7696ca20612a33b7d87215a801 100644
--- a/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java
+++ b/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java
@@ -185,7 +185,7 @@ public final class CraftMagicNumbers implements UnsafeValues {
 
     public static Item getItem(Material material) {
         if (material != null && material.isLegacy()) {
-            material = CraftLegacy.fromLegacy(material);
+            material = CraftLegacy.fromLegacy(material, true); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         }
 
         return CraftMagicNumbers.MATERIAL_ITEM.get(material);
@@ -193,7 +193,7 @@ public final class CraftMagicNumbers implements UnsafeValues {
 
     public static Block getBlock(Material material) {
         if (material != null && material.isLegacy()) {
-            material = CraftLegacy.fromLegacy(material);
+            material = CraftLegacy.fromLegacy(material, false); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
         }
 
         return CraftMagicNumbers.MATERIAL_BLOCK.get(material);
@@ -229,12 +229,12 @@ public final class CraftMagicNumbers implements UnsafeValues {
 
     @Override
     public Material fromLegacy(Material material) {
-        return CraftLegacy.fromLegacy(material);
+        return this.fromLegacy(material, false); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
     }
 
     @Override
     public Material fromLegacy(MaterialData material) {
-        return CraftLegacy.fromLegacy(material);
+        return this.fromLegacy(material, false); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
     }
 
     @Override
diff --git a/src/test/java/org/bukkit/craftbukkit/legacy/LegacyTest.java b/src/test/java/org/bukkit/craftbukkit/legacy/LegacyTest.java
index bcbf4252a7876406bed1ca81b00a0986a036dc7f..08198e93e12a84d3e39de778a0ff0c4537d5b87e 100644
--- a/src/test/java/org/bukkit/craftbukkit/legacy/LegacyTest.java
+++ b/src/test/java/org/bukkit/craftbukkit/legacy/LegacyTest.java
@@ -128,10 +128,10 @@ public class LegacyTest extends AbstractTestingBase {
                 assertNotEquals(Material.LEGACY_AIR, converted.getItemType(), "Could not toLegacy " + material);
 
                 if (!this.INVALIDATED_MATERIALS.contains(converted.getItemType())) {
-                    assertNotEquals(Material.AIR, CraftLegacy.fromLegacy(converted), "Could not fromLegacy(toLegacy) " + converted + "(" + material + ")");
+                    assertNotEquals(Material.AIR, CraftLegacy.fromLegacy(converted, false), "Could not fromLegacy(toLegacy) " + converted + "(" + material + ")"); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
                 }
                 if (!this.INVERSION_FAILS.contains(material)) {
-                    assertEquals(material, CraftLegacy.fromLegacy(converted), "Could not fromLegacy(toLegacy) " + converted + "(" + material + ")");
+                    assertEquals(material, CraftLegacy.fromLegacy(converted, false), "Could not fromLegacy(toLegacy) " + converted + "(" + material + ")"); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
                 }
             }
         }
@@ -143,8 +143,8 @@ public class LegacyTest extends AbstractTestingBase {
     public void fromLegacyMaterial() {
         for (Material material : Material.values()) {
             if (!this.INVALIDATED_MATERIALS.contains(material) && material.isLegacy()) {
-                Material converted = CraftLegacy.fromLegacy(material);
-                assertNotEquals(Material.AIR, converted, "Could not fromLegacy " + material);
+                Material converted = CraftLegacy.fromLegacy(material, false);
+                assertNotEquals(Material.AIR, converted, "Could not fromLegacy " + material); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
 
                 assertNotEquals(Material.AIR, CraftLegacy.toLegacy(converted), "Could not toLegacy(fromLegacy) " + converted + "(" + material + ")");
                 if (!this.INVERSION_FAILS.contains(material)) {
@@ -153,7 +153,7 @@ public class LegacyTest extends AbstractTestingBase {
             }
         }
 
-        assertEquals(Material.AIR, CraftLegacy.fromLegacy(Material.LEGACY_AIR), "Could not fromLegacy Air");
+        assertEquals(Material.AIR, CraftLegacy.fromLegacy(Material.LEGACY_AIR, false), "Could not fromLegacy Air"); // Fiddle - modifiable Bukkit enums - Material - make legacy conversion complete - conversion is explicitly for item or block
     }
 
     @Test
