From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Sun, 23 Jul 2023 18:40:48 +0200
Subject: [PATCH] Client perspective - Localization - Send replaceable updates
 after locale change

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Fiddle - https://fiddlemc.org

diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index 84cbb6d687486ac3459b38a1b229dfcc72f5ed2f..04621375f58cdfd44a13d6469b9fb389fc2c6c66 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -2040,12 +2040,20 @@ public class ServerPlayer extends Player {
             PlayerChangedMainHandEvent event = new PlayerChangedMainHandEvent(this.getBukkitEntity(), getMainArm() == HumanoidArm.LEFT ? MainHand.LEFT : MainHand.RIGHT);
             this.server.server.getPluginManager().callEvent(event);
         }
-        if (this.locale == null || !this.locale.equals(packet.language)) { // Paper - check for null
+        // Fiddle start - client perspective - localization - send update packets for replaceables after locale change
+        boolean localeChanged = this.locale == null || !this.locale.equals(packet.language);
+        if (localeChanged) { // Paper - check for null
+            // Fiddle end - client perspective - localization - send update packets for replaceables after locale change
             PlayerLocaleChangeEvent event = new PlayerLocaleChangeEvent(this.getBukkitEntity(), packet.language);
             this.server.server.getPluginManager().callEvent(event);
             this.server.server.getPluginManager().callEvent(new com.destroystokyo.paper.event.player.PlayerLocaleChangeEvent(this.getBukkitEntity(), this.locale, packet.language)); // Paper
         }
         this.locale = packet.language;
+        // Fiddle start - client perspective - localization - send update packets for replaceables after locale change
+        if (localeChanged && this.hasFinishedBeingPlacedIntoPlayerList) {
+            this.sendUpdatesForDeepReplaceableContent(true, true);
+        }
+        // Fiddle end - client perspective - localization - send update packets for replaceables after locale change
         // Paper start
         this.adventure$locale = net.kyori.adventure.translation.Translator.parseLocale(this.locale);
         this.connection.connection.channel.attr(PaperAdventure.LOCALE_ATTRIBUTE).set(this.adventure$locale);
