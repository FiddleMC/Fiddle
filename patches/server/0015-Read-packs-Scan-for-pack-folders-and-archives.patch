From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Sat, 6 May 2023 11:54:19 +0200
Subject: [PATCH] Read packs - Scan for pack folders and archives

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Fiddle - https://fiddlemc.org

diff --git a/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java b/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java
index c50ad86b7a533f788d59c18973ae0d81b3b12189..07514ab582d973234ed8f4d1f8896762475d4b1c 100644
--- a/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java
+++ b/src/main/java/org/fiddlemc/fiddle/pack/reader/PackReader.java
@@ -6,22 +6,87 @@ import com.mojang.logging.LogUtils;
 import joptsimple.OptionSet;
 import org.slf4j.Logger;
 
+import java.io.File;
+import java.io.IOException;
+import java.util.*;
+
 /**
  * A singleton providing the {@link #readPacks} method.
  */
 public final class PackReader {
 
+    public static final String fiddlePacksFolderName = "fiddle_packs";
+
     public static final Logger LOGGER = LogUtils.getClassLogger();
 
     private PackReader() {
         throw new RuntimeException();
     }
 
+    private static final List<PackBeingRead> packs = new ArrayList<>();
+
     /**
      * Scans for packs in the appropriate places, and performs preparatory reading of their contents,
      * including making sure that they are valid in every way that is possible to tell at this stage,
      * so that their contents may be used at the right moment later, such as during block registry.
      */
-    public static void readPacks(OptionSet optionSet) {}
+    public static void readPacks(OptionSet optionSet) {
+
+        // Scan and open the packs
+        scanForPacks(optionSet);
+
+        // Close the opened packs
+        packs.forEach(pack -> {
+            try {
+                pack.close();
+            } catch (IOException e) {
+                throw new RuntimeException("Exception while closing a pack being read", e);
+            }
+        });
+
+        // Deallocate the opened packs
+        packs.clear();
+
+    }
+
+    /**
+     * Scans for packs in the appropriate folders,
+     * and adds initial {@link PackBeingRead} instances to {@link #packs}.
+     */
+    private static void scanForPacks(OptionSet optionSet) {
+        for (var checkingPlugins : new boolean[] {false, true}) {
+            var folder = checkingPlugins ? (File) optionSet.valueOf("plugins") : new File(fiddlePacksFolderName);
+            if (folder.exists() && folder.isDirectory()) {
+                for (var file : Objects.requireNonNull(folder.listFiles())) {
+                    var lowerCaseName = file.getName().toLowerCase(Locale.ROOT);
+                    // Accept .jar files in the packs folder too (to use them as packs without the plugin code, which is useful if the code has broken after an update)
+                    if (lowerCaseName.endsWith(".jar") || (!checkingPlugins && (lowerCaseName.endsWith(".zip") || lowerCaseName.endsWith(".rar") || file.isDirectory()))) {
+                        scanForPack(file);
+                    }
+                }
+            } else if (!checkingPlugins) {
+                //noinspection ResultOfMethodCallIgnored
+                folder.mkdir();
+            }
+        }
+    }
+
+    /**
+     * Scans the given file, which may or may not be a pack.
+     * It will be opened and added to {@link #packs} as a {@link PackBeingRead} if it appears to be a pack.
+     */
+    private static void scanForPack(File packFile) {
+        try {
+            PackBeingRead pack;
+            if (packFile.isDirectory()) {
+                pack = new DirectoryPackBeingRead(packFile);
+            } else {
+                pack = new ArchivePackBeingRead(packFile);
+            }
+            // TODO Scan the meta file
+        } catch (Exception e) {
+            LOGGER.warn("An exception occurred while checking if a file or folder '" + packFile.getPath() + "' is a Fiddle pack. The file or folder will not be loaded.", e);
+        }
+    }
 
 }
