From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Sat, 22 Jul 2023 21:48:49 +0200
Subject: [PATCH] Client perspective - Item replacements - Pass context of
 items in item frames

License: Fiddle Public License Agreement 1.0 (included in license/FPL-1.0.txt)
Fiddle - https://fiddlemc.org

diff --git a/src/main/java/net/minecraft/network/protocol/game/ClientboundSetEntityDataPacket.java b/src/main/java/net/minecraft/network/protocol/game/ClientboundSetEntityDataPacket.java
index 90ee2dbf35b5cd6433a02c08f1ac9464d2063fcb..59f5d44d8ac354d90923013c3648ae179e74c4c0 100644
--- a/src/main/java/net/minecraft/network/protocol/game/ClientboundSetEntityDataPacket.java
+++ b/src/main/java/net/minecraft/network/protocol/game/ClientboundSetEntityDataPacket.java
@@ -5,16 +5,23 @@ import java.util.List;
 import net.minecraft.network.FriendlyByteBuf;
 import net.minecraft.network.syncher.SynchedEntityData;
 import org.fiddlemc.fiddle.packet.PacketWithExplicitTargetClientConnection;
+import org.fiddlemc.fiddle.packet.item.ItemStackInPacketContext;
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
 
 // Fiddle start - client perspective - item replacements - store connection explicitly in packets that may contain items
 public class ClientboundSetEntityDataPacket extends PacketWithExplicitTargetClientConnection<ClientGamePacketListener> {
     private final int id;
     private final List<SynchedEntityData.DataValue<?>> packedItems;
+    // Fiddle start - client perspective - item replacements - pass context of items in item frames
+    private final @Nullable ItemStackInPacketContext itemStackContext;
 
-    public ClientboundSetEntityDataPacket(int id, List<SynchedEntityData.DataValue<?>> packedItems) {
+    public ClientboundSetEntityDataPacket(int id, List<SynchedEntityData.DataValue<?>> packedItems, @NotNull ItemStackInPacketContext itemStackContext) {
+        // Fiddle end - client perspective - item replacements - pass context of items in item frames
         super();
         this.id = id;
         this.packedItems = packedItems;
+        this.itemStackContext = itemStackContext; // Fiddle - client perspective - item replacements - pass context of items in item frames
     }
 
     public int id() {
@@ -29,12 +36,12 @@ public class ClientboundSetEntityDataPacket extends PacketWithExplicitTargetClie
     public static final int EOF_MARKER = 255;
 
     public ClientboundSetEntityDataPacket(FriendlyByteBuf buf) {
-        this(buf.readVarInt(), unpack(buf));
+        this(buf.readVarInt(), unpack(buf), null); // Fiddle - client perspective - item replacements - pass context of items in item frames
     }
 
-    private static void pack(List<SynchedEntityData.DataValue<?>> trackedValues, FriendlyByteBuf buf) {
+    private static void pack(List<SynchedEntityData.DataValue<?>> trackedValues, FriendlyByteBuf buf, @Nullable ItemStackInPacketContext itemStackContext) { // Fiddle - client perspective - item replacements - pass context of items in item frames
         for(SynchedEntityData.DataValue<?> dataValue : trackedValues) {
-            dataValue.write(buf);
+            dataValue.write(buf, itemStackContext); // Fiddle - client perspective - item replacements - pass context of items in item frames
         }
 
         buf.writeByte(255);
@@ -54,7 +61,7 @@ public class ClientboundSetEntityDataPacket extends PacketWithExplicitTargetClie
     @Override
     public void write(FriendlyByteBuf buf) {
         buf.writeVarInt(this.id);
-        pack(this.packedItems, buf);
+        pack(this.packedItems, buf, this.itemStackContext); // Fiddle - client perspective - item replacements - pass context of items in item frames
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/network/syncher/EntityDataSerializers.java b/src/main/java/net/minecraft/network/syncher/EntityDataSerializers.java
index 9ca897d92c5bdd2764d114c74d64c776674d6beb..69074d571121e710ee1561aaeb873983de41e972 100644
--- a/src/main/java/net/minecraft/network/syncher/EntityDataSerializers.java
+++ b/src/main/java/net/minecraft/network/syncher/EntityDataSerializers.java
@@ -25,6 +25,8 @@ import net.minecraft.world.entity.npc.VillagerData;
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.world.level.block.Block;
 import net.minecraft.world.level.block.state.BlockState;
+import org.fiddlemc.fiddle.packet.item.ItemStackInPacketContext;
+import org.jetbrains.annotations.NotNull;
 import org.joml.Quaternionf;
 import org.joml.Vector3f;
 
@@ -39,10 +41,20 @@ public class EntityDataSerializers {
     public static final EntityDataSerializer<String> STRING = EntityDataSerializer.simple(FriendlyByteBuf::writeUtf, FriendlyByteBuf::readUtf);
     public static final EntityDataSerializer<Component> COMPONENT = EntityDataSerializer.simple(FriendlyByteBuf::writeComponent, FriendlyByteBuf::readComponent);
     public static final EntityDataSerializer<Optional<Component>> OPTIONAL_COMPONENT = EntityDataSerializer.optional(FriendlyByteBuf::writeComponent, FriendlyByteBuf::readComponent);
-    public static final EntityDataSerializer<ItemStack> ITEM_STACK = new EntityDataSerializer<ItemStack>() {
+    // Fiddle start - client perspective - item replacements - pass context of items in item frames
+    public static abstract class ItemStackEntityDataSerializer implements EntityDataSerializer<ItemStack> {
+
+        public void write(FriendlyByteBuf buf, ItemStack value, @NotNull ItemStackInPacketContext itemStackInPacketContext) {
+            var sanitizedItemStack = net.minecraft.world.entity.LivingEntity.sanitizeItemStack(value, true);
+            buf.writeItem(sanitizedItemStack, itemStackInPacketContext); // Paper start - prevent oversized data
+        }
+
+    }
+    public static final EntityDataSerializer<ItemStack> ITEM_STACK = new ItemStackEntityDataSerializer() {
+        // Fiddle end - client perspective - item replacements - pass context of items in item frames
         @Override
         public void write(FriendlyByteBuf buf, ItemStack value) {
-            buf.writeItem(net.minecraft.world.entity.LivingEntity.sanitizeItemStack(value, true)); // Paper - prevent oversized data
+            throw new UnsupportedOperationException(); // Fiddle - client perspective - item replacements - pass context of items in item frames
         }
 
         @Override
diff --git a/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java b/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java
index 5dfb35117c285e0b202dc9c088ad5848beb8d054..368f32dc793867c1bf4a204020f513978f18a200 100644
--- a/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java
+++ b/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java
@@ -22,7 +22,9 @@ import net.minecraft.network.FriendlyByteBuf;
 import net.minecraft.network.protocol.game.ClientboundSetEntityDataPacket;
 import net.minecraft.server.level.ServerPlayer;
 import net.minecraft.world.entity.Entity;
+import net.minecraft.world.item.ItemStack;
 import org.apache.commons.lang3.ObjectUtils;
+import org.fiddlemc.fiddle.packet.item.ItemStackInPacketContext;
 import org.slf4j.Logger;
 
 public class SynchedEntityData {
@@ -279,7 +281,7 @@ public class SynchedEntityData {
 
             if (list != null) {
                 if (to.getBukkitEntity().canSee(this.entity.getBukkitEntity())) { // Paper
-                to.connection.send(new ClientboundSetEntityDataPacket(this.entity.getId(), list));
+                to.connection.send(new ClientboundSetEntityDataPacket(this.entity.getId(), list, this.entity.getItemStackInPacketContext())); // Fiddle - client perspective - item replacements - pass context of items in item frames
                 } // Paper
             }
         }
@@ -326,7 +328,7 @@ public class SynchedEntityData {
             values.add(synchedValue.value());
         }
 
-        to.connection.send(new ClientboundSetEntityDataPacket(this.entity.getId(), values));
+        to.connection.send(new ClientboundSetEntityDataPacket(this.entity.getId(), values, this.entity.getItemStackInPacketContext())); // Fiddle - client perspective - item replacements - pass context of items in item frames
     }
     // Paper end
 
@@ -380,7 +382,7 @@ public class SynchedEntityData {
             return new SynchedEntityData.DataValue<>(data.getId(), datawatcherserializer, datawatcherserializer.copy(value));
         }
 
-        public void write(FriendlyByteBuf buf) {
+        public void write(FriendlyByteBuf buf, @Nullable ItemStackInPacketContext itemStackInPacketContext) { // Fiddle - client perspective - item replacements - pass context of items in item frames
             int i = EntityDataSerializers.getSerializedId(this.serializer);
 
             if (i < 0) {
@@ -388,7 +390,13 @@ public class SynchedEntityData {
             } else {
                 buf.writeByte(this.id);
                 buf.writeVarInt(i);
-                this.serializer.write(buf, this.value);
+                // Fiddle start - client perspective - item replacements - pass context of items in item frames
+                if (this.serializer instanceof EntityDataSerializers.ItemStackEntityDataSerializer itemStackSerializer) {
+                    itemStackSerializer.write(buf, (ItemStack) this.value, Objects.requireNonNull(itemStackInPacketContext));
+                } else {
+                    this.serializer.write(buf, this.value);
+                }
+                // Fiddle end - client perspective - item replacements - pass context of items in item frames
             }
         }
 
diff --git a/src/main/java/net/minecraft/server/level/ServerEntity.java b/src/main/java/net/minecraft/server/level/ServerEntity.java
index 81d0b2933040a451441f660f9e46199ae3b111e3..a604fb849c5c880233b416f95c57ebb060a3fe2e 100644
--- a/src/main/java/net/minecraft/server/level/ServerEntity.java
+++ b/src/main/java/net/minecraft/server/level/ServerEntity.java
@@ -300,7 +300,7 @@ public class ServerEntity {
         this.yHeadRotp = Mth.floor(this.entity.getYHeadRot() * 256.0F / 360.0F);
         sender.accept(packet);
         if (this.trackedDataValues != null) {
-            sender.accept(new ClientboundSetEntityDataPacket(this.entity.getId(), this.trackedDataValues));
+            sender.accept(new ClientboundSetEntityDataPacket(this.entity.getId(), this.trackedDataValues, this.entity.getItemStackInPacketContext())); // Fiddle - client perspective - item replacements - pass context of items in item frames
         }
 
         boolean flag = this.trackDelta;
@@ -375,7 +375,7 @@ public class ServerEntity {
 
         if (list != null) {
             this.trackedDataValues = datawatcher.getNonDefaultValues();
-            this.broadcastAndSend(new ClientboundSetEntityDataPacket(this.entity.getId(), list));
+            this.broadcastAndSend(new ClientboundSetEntityDataPacket(this.entity.getId(), list, this.entity.getItemStackInPacketContext())); // Fiddle - client perspective - item replacements - pass context of items in item frames
         }
 
         if (this.entity instanceof LivingEntity) {
diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 305b43071aa1cf8feee75fae757bb7734ae33771..3527d68fd74b4adaf00479bceb0805dc85d7af19 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -125,6 +125,8 @@ import net.minecraft.world.phys.shapes.Shapes;
 import net.minecraft.world.phys.shapes.VoxelShape;
 import net.minecraft.world.scores.PlayerTeam;
 import net.minecraft.world.scores.Team;
+import org.fiddlemc.fiddle.packet.item.ItemStackInPacketContext;
+import org.jetbrains.annotations.NotNull;
 import org.slf4j.Logger;
 import org.bukkit.Bukkit;
 import org.bukkit.Location;
@@ -4789,4 +4791,11 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
         return ((net.minecraft.server.level.ServerChunkCache) level.getChunkSource()).isPositionTicking(this);
     }
     // Paper end
+
+    // Fiddle start - client perspective - item replacements - pass context of items in item frames
+    public @NotNull ItemStackInPacketContext getItemStackInPacketContext() {
+        return ItemStackInPacketContext.DEFAULT;
+    }
+    // Fiddle end - client perspective - item replacements - pass context of items in item frames
+
 }
diff --git a/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java b/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java
index 955316687e2e29ad75a0052317a7b0f89034c82a..7142c180afb65c422d63385d32f2056251f3f6c9 100644
--- a/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java
+++ b/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java
@@ -7,10 +7,12 @@ import io.papermc.paper.event.player.PlayerItemFrameChangeEvent; // Paper
 import net.minecraft.core.BlockPos;
 import net.minecraft.core.Direction;
 import net.minecraft.nbt.CompoundTag;
+import net.minecraft.network.FriendlyByteBuf;
 import net.minecraft.network.protocol.Packet;
 import net.minecraft.network.protocol.game.ClientGamePacketListener;
 import net.minecraft.network.protocol.game.ClientboundAddEntityPacket;
 import net.minecraft.network.syncher.EntityDataAccessor;
+import net.minecraft.network.syncher.EntityDataSerializer;
 import net.minecraft.network.syncher.EntityDataSerializers;
 import net.minecraft.network.syncher.SynchedEntityData;
 import net.minecraft.sounds.SoundEvent;
@@ -40,6 +42,8 @@ import net.minecraft.world.level.saveddata.maps.MapItemSavedData;
 import net.minecraft.world.phys.AABB;
 import net.minecraft.world.phys.Vec3;
 import org.apache.commons.lang3.Validate;
+import org.fiddlemc.fiddle.packet.item.ItemStackInPacketContext;
+import org.jetbrains.annotations.NotNull;
 import org.slf4j.Logger;
 
 public class ItemFrame extends HangingEntity {
@@ -539,4 +543,12 @@ public class ItemFrame extends HangingEntity {
 
         return (float) Mth.wrapDegrees(180 + enumdirection.get2DDataValue() * 90 + this.getRotation() * 45 + i);
     }
+
+    // Fiddle start - client perspective - item replacements - pass context of items in item frames
+    @Override
+    public @NotNull ItemStackInPacketContext getItemStackInPacketContext() {
+        return ItemStackInPacketContext.IN_ITEM_FRAME;
+    }
+    // Fiddle end - client perspective - item replacements - pass context of items in item frames
+
 }
